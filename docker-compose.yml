services:
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: app
    image: papersome-app:latest
    env_file:
      - .env
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      LOG_CHANNEL: stderr
      LOG_LEVEL: info
      DB_CONNECTION: mysql
      DB_HOST: db
      DB_PORT: 3306
      REDIS_HOST: redis
      QUEUE_CONNECTION: redis
      SESSION_DRIVER: redis
      CACHE_STORE: redis
      BROWSERSHOT_NO_SANDBOX: "true"
      BROWSERSHOT_BASE_URL: http://web
    volumes:
      - storage:/var/www/html/storage
    healthcheck:
      test: ["CMD", "php", "-v"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - appnet

  web:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: web
    image: papersome-web:latest
    depends_on:
      - app
    ports:
      - "8080:80"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - storage:/var/www/html/storage:ro
    networks:
      - appnet

  db:
    image: mariadb:11
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-papersome}
      MYSQL_USER: ${DB_USERNAME:-papersome}
      MYSQL_PASSWORD: ${DB_PASSWORD:-secret}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root}
    volumes:
      - dbdata:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - appnet

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - appnet

  chromium:
    image: zenika/alpine-chrome
    command: [ "--headless", "--disable-gpu", "--remote-debugging-address=0.0.0.0", "--remote-debugging-port=9222" ]
    cap_add:
      - SYS_ADMIN
    networks:
      - appnet

  worker:
    image: papersome-app:latest
    depends_on:
      - app
      - redis
      - db
    env_file:
      - .env
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      QUEUE_CONNECTION: redis
      REDIS_HOST: redis
      BROWSERSHOT_BASE_URL: http://web
    command: ["php", "artisan", "queue:work", "--sleep=1", "--tries=3", "--max-time=3600"]
    restart: unless-stopped
    volumes:
      - storage:/var/www/html/storage
    networks:
      - appnet

  scheduler:
    image: papersome-app:latest
    depends_on:
      - app
      - db
      - redis
    env_file:
      - .env
    environment:
      APP_ENV: production
      BROWSERSHOT_BASE_URL: http://web
    command: ["php", "artisan", "schedule:work"]
    restart: unless-stopped
    volumes:
      - storage:/var/www/html/storage
    networks:
      - appnet

volumes:
  dbdata:
  storage:

networks:
  appnet:
    driver: bridge
